############################################################################
# Title:            Bizbox: Uninstall | Uninstall apps Task                #
# Author(s):        btmarouane                                             #
# URL:              https://github.com/GrecoTechnology/Bizbox              #
# --                                                                       #
############################################################################
#                   GNU General Public License v3.0                        #
############################################################################
---
- name: Remove apps | Set app name
  set_fact:
    app: "{{'invoice' if item in ['invoiceninja', 'invoiceninjav5'] else item}}"
  when: item is defined

- name: Remove apps | Remove containers
  block:
  - name: Remove apps | Remove containers | Remove container
    ansible.builtin.include_tasks: "{{ resources_tasks_path }}/docker/remove_docker_container.yml"
    vars:
      uninstall_docker_container: "{{ user.domain | replace('.','-')+'-'+app }}"

  - name: Remove apps | Remove containers | Remove invoiceninjav5 nginx container
    ansible.builtin.include_tasks: "{{ resources_tasks_path }}/docker/remove_docker_container.yml"
    vars:
      uninstall_docker_container: "{{ user.domain | replace('.','-')+'-'+app+'-nginx' }}"
    when: app == "invoice"

  - name: Remove apps | Remove containers | Remove traefik redis and authelia containers
    ansible.builtin.include_tasks: "{{ resources_tasks_path }}/docker/remove_docker_container.yml"
    vars:
      uninstall_docker_container: "{{ user.domain | replace('.','-')+'-'+traefik_item }}"
    with_items:
      - redis
      - authelia
    loop_control:
      loop_var: traefik_item
    when: app == "traefik"

- name: Remove apps | Remove db
  block:
  - name: Remove apps | Remove wordpress database
    command: docker exec {{ mariadb_docker_container }} mysql -u{{root_user}} -p{{ root_password }} -e "DROP DATABASE wordpress;"
    when: app == "wordpress"

  - name: Remove apps | Remove invoiceninjav5 database
    command: docker exec {{ mariadb_docker_container }} mysql -u{{root_user}} -p{{ root_password }} -e "DROP DATABASE invoice;"
    when: app == "invoice"
  when: all is defined and all == 'false'

- name: Remove apps | Remove files
  block:
  - name: Remove apps | Remove files | Remove appdata files
    ansible.builtin.file:
      path: "{{ server_appdata_path }}/{{ app }}"
      state: absent

  - name: Remove apps | Remove files | Remove traefik redis and authelia appdata files
    ansible.builtin.file:
      path: "{{ server_appdata_path }}/{{ traefik_item }}"
      state: absent
    with_items:
      - redis
      - authelia
    loop_control:
      loop_var: traefik_item
    when: app == "traefik"

  - name: Remove apps | Remove files | Remove http_headers.yml file
    ansible.builtin.file:
      path: "{{ traefik_path_http_headers_config_location }}/{{ user.domain | replace('.','-')+'-'+app+'-http-headers.yml' }}"
      state: absent

  - name: Remove apps | Remove files | Remove traefik config
    ansible.builtin.file:
      path: "/opt/traefik"
      state: absent
    when: app == "traefik"
